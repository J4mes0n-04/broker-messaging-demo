sequenceDiagram
    participant Test as Запуск теста
    participant Producer as Producer
    participant Kafka as Kafka
    participant Consumer as Consumer
    participant Assert as TEST

    Note over Test,Assert: Интеграционный тест: Поток сообщений

    rect rgb(220, 200, 255)
    Note over Test,Producer: Фаза инициализации
    Test->>Producer: Создать Producer(bootstrap.servers='localhost:9092')
    Test->>Consumer: Создать Consumer(group.id='test-group', auto.offset.reset='latest')
    Consumer->>Kafka: subscribe(['orders'])
    Kafka-->>Consumer: Подписка подтверждена
    end

    rect rgb(200, 220, 255)
    Note over Test,Kafka: Фаза выполнения теста
    Test->>Test: Создать test_msg={'order_id':999, 'amount':999.99}
    Test->>Producer: produce('orders', value=json_test_msg)
    Producer->>Kafka: Отправить сообщение
    Kafka-->>Producer: Сохранено в партицию
    Test->>Producer: flush()
    Producer-->>Test: Все сообщения отправлены
    end

    rect rgb(200, 255, 220)
    Note over Test,Assert: Фаза проверки
    Test->>Consumer: poll(timeout=5.0)
    Kafka-->>Consumer: Сообщение получено
    Consumer->>Consumer: json.loads(message)
    Consumer-->>Test: Сообщение получено
    
    Test->>Assert: assertIsNotNone(msg)
    Assert-->>Test: ✓ Сообщение существует
    
    Test->>Assert: assertEqual(received['order_id'], 999)
    Assert-->>Test: ✓ ID заказа совпадает
    end

    rect rgb(255, 240, 200)
    Note over Test,Consumer: Фаза очистки
    Test->>Consumer: close()
    Consumer-->>Test: Консьюмер закрыт
    Test->>Test: Тест завершен успешно
    end

    Note over Test: Интеграционный тест ПРОЙДЕН

